{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë„ì‹œë½ ì˜ˆì•½ - ë§ˆì„í•œë¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

<div class="phone-frame">

  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="mh-header">
    <button class="mh-back-btn" onclick="history.back()">&#x2039; Back</button>
    <div class="mh-header-title">ë„ì‹œë½ ì˜ˆì•½</div>
    <div class="mh-header-spacer"></div>
  </header>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="mh-main">
    <form class="mh-form" id="reserve-form">

      <!-- í”½ì—… ì‹œê°„ -->
      <section class="mh-card">
        <p class="mh-card-title-highlight">
          <strong>í”½ì—… ì‹œê°„</strong>ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>
        <p class="mh-help-text">í”½ì—… ê°€ëŠ¥ ì‹œê°„: 08:00 ~ 19:00</p>

        <div class="mh-time-row">
          <select name="hour" class="mh-input mh-input-inline" id="hour-select" required>
            <option value="">ì‹œ</option>
            <option value="08">08</option>
            <option value="09">09</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
          </select>

         <select name="minute" class="mh-input mh-input-inline" id="minute-select" required>
             <option value="">ë¶„</option>
             <option value="00">00</option>
             <option value="05">05</option>
             <option value="10">10</option>
             <option value="15">15</option>
             <option value="20">20</option>
             <option value="25">25</option>
             <option value="30">30</option>
             <option value="35">35</option>
             <option value="40">40</option>
             <option value="45">45</option>
             <option value="50">50</option>
             <option value="55">55</option>
            </select>
        </div>
      </section>

      <!-- í”½ì—… ì¥ì†Œ -->
      <section class="mh-card">
        <p class="mh-card-title-highlight">
          <strong>í”½ì—… ì¥ì†Œ</strong>ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>

        <select name="pickup_place" class="mh-input" id="pickup-select" required>
          <option value="">í”½ì—… ì¥ì†Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</option>
          <option value="hall">í•™ìƒíšŒê´€ í”½ì—…ì¡´</option>
          <option value="plaza">ì—°ì„¸í”Œë¼ì í”½ì—…ì¡´</option>
        </select>
      </section>

      <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
      <section class="mh-card">
        <p class="mh-card-title">ìˆ˜ëŸ‰</p>

        <div class="mh-qty-row">
          <button type="button" class="mh-qty-btn" id="qty-minus">-</button>
          <span class="mh-qty-value" id="qty-display">1ê°œ</span>
          <button type="button" class="mh-qty-btn" id="qty-plus">+</button>
        </div>

        <p class="mh-stock-text" id="stock-info">ì¬ê³ : 7ê°œ</p>
        <p class="mh-stock-warning" id="stock-warning">7ê°œê¹Œì§€ ì£¼ë¬¸ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>

        <p class="mh-total-text" id="total-price">
          ì´ì•¡: <span>9,000ì›</span>
        </p>
      </section>

      <!-- ê²°ì œ ì •ë³´ -->
      <section class="mh-card">
        <p class="mh-card-title">ê²°ì œì˜ˆì •ê¸ˆì•¡</p>

        <div class="mh-payment-detail">
          <div class="mh-payment-row">
            <span class="mh-payment-label">ì”ì•¡</span>
            <span class="mh-payment-value" id="balance-display">50,000ì›</span>
          </div>
          <div class="mh-payment-row">
            <span class="mh-payment-label">ê²°ì œê¸ˆì•¡</span>
            <span class="mh-payment-value" id="payment-amount">9,000ì›</span>
          </div>
          <div class="mh-payment-divider"></div>
          <div class="mh-payment-row mh-payment-result">
            <span class="mh-payment-label" id="result-label">ë‚¨ì€ ì”ì•¡</span>
            <span class="mh-payment-value" id="result-amount">41,000ì›</span>
          </div>
        </div>

        <!-- ì”ì•¡ ë¶€ì¡± ê²½ê³  -->
        <div class="mh-balance-warning" id="balance-warning">
          <p>ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!</p>
          <p>
            <a href="{% url 'charge' %}" class="mh-charge-link" id="charge-link">ì¶©ì „í•˜ê¸°</a>
          </p>
        </div>
      </section>

      <!-- hidden inputs for form submission -->
      <input type="hidden" name="quantity" id="hidden-quantity" value="1">
      <input type="hidden" name="total_price" id="hidden-total-price" value="9000">

    </form>
  </main>

  <!-- í•˜ë‹¨ ì˜ˆì•½ ë²„íŠ¼ -->
  <div class="mh-bottom-btn-wrap">
    <button type="button" class="mh-main-btn" id="reserve-btn">ì˜ˆì•½í•˜ê¸°</button>
  </div>

</div>

<script>
  // ğŸ”´ ë°±ì—”ë“œ ì—°ë™ ì‹œ: const UNIT_PRICE = {{ lunch.price }};
  const UNIT_PRICE = 9000;

  // ğŸ”´ ë°±ì—”ë“œ ì—°ë™ ì‹œ: const STOCK_QTY = {{ lunch.stock }};
  const STOCK_QTY = 7;

  // ğŸ”´ ë°±ì—”ë“œ ì—°ë™ ì‹œ: const USER_BALANCE = {{ user.balance }};
  // URL íŒŒë¼ë¯¸í„°ë¡œ balance ë°›ê¸° (chargeì—ì„œ ì „ë‹¬)
  const urlParams = new URLSearchParams(window.location.search);
  const USER_BALANCE = parseInt(urlParams.get('balance')) || 50000;

  const MIN_QTY = 1;
  const MAX_QTY = 10;

  let currentQty = 1;

  // DOM ìš”ì†Œ
  const qtyDisplay = document.getElementById('qty-display');
  const stockInfo = document.getElementById('stock-info');
  const stockWarning = document.getElementById('stock-warning');
  const totalPriceSpan = document.getElementById('total-price').querySelector('span');
  const balanceDisplay = document.getElementById('balance-display');
  const paymentAmount = document.getElementById('payment-amount');
  const resultLabel = document.getElementById('result-label');
  const resultAmount = document.getElementById('result-amount');
  const balanceWarning = document.getElementById('balance-warning');
  const chargeLink = document.getElementById('charge-link');
  const reserveBtn = document.getElementById('reserve-btn');

  const hiddenQuantity = document.getElementById('hidden-quantity');
  const hiddenTotalPrice = document.getElementById('hidden-total-price');

  // ì´ˆê¸° í‘œì‹œ
  balanceDisplay.textContent = formatNumber(USER_BALANCE) + 'ì›';
  updateDisplay();

  // ìˆ˜ëŸ‰ ì¦ê°€
  document.getElementById('qty-plus').addEventListener('click', function() {
    if (currentQty < Math.min(STOCK_QTY, MAX_QTY)) {
      currentQty++;
      updateDisplay();
    }

    if (currentQty === Math.min(STOCK_QTY, MAX_QTY)) {
      stockWarning.style.display = 'block';
    }
  });

  // ìˆ˜ëŸ‰ ê°ì†Œ
  document.getElementById('qty-minus').addEventListener('click', function() {
    if (currentQty > MIN_QTY) {
      currentQty--;
      updateDisplay();
      stockWarning.style.display = 'none';
    }
  });

  // í™”ë©´ ì—…ë°ì´íŠ¸
  function updateDisplay() {
    const totalPrice = UNIT_PRICE * currentQty;
    const remaining = USER_BALANCE - totalPrice;

    // ìˆ˜ëŸ‰ ë° ê°€ê²© í‘œì‹œ
    qtyDisplay.textContent = currentQty + 'ê°œ';
    totalPriceSpan.textContent = formatNumber(totalPrice) + 'ì›';
    paymentAmount.textContent = formatNumber(totalPrice) + 'ì›';

    // hidden inputs ì—…ë°ì´íŠ¸
    hiddenQuantity.value = currentQty;
    hiddenTotalPrice.value = totalPrice;

    // ì”ì•¡ ì²´í¬
    if (remaining < 0) {
      // ì”ì•¡ ë¶€ì¡±
      resultLabel.textContent = 'ë¶€ì¡± ê¸ˆì•¡';
      resultAmount.textContent = formatNumber(Math.abs(remaining)) + 'ì›';
      resultAmount.style.color = '#e03131';
      balanceWarning.style.display = 'block';

      // ì¶©ì „í•˜ê¸° ë§í¬ í”ë“¤ë¦¼
      chargeLink.classList.add('shake');
      setTimeout(() => {
        chargeLink.classList.remove('shake');
      }, 1500);
    } else {
      // ì”ì•¡ ì¶©ë¶„
      resultLabel.textContent = 'ë‚¨ì€ ì”ì•¡';
      resultAmount.textContent = formatNumber(remaining) + 'ì›';
      resultAmount.style.color = '#12b886';
      balanceWarning.style.display = 'none';
    }
  }

  // ìˆ«ì í¬ë§·
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }

  // ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­
  reserveBtn.addEventListener('click', function() {
    const hourSelect = document.getElementById('hour-select');
    const minuteSelect = document.getElementById('minute-select');
    const pickupSelect = document.getElementById('pickup-select');

    // ìœ íš¨ì„± ê²€ì¦ 1: ì‹œê°„ ì„ íƒ
    if (!hourSelect.value || !minuteSelect.value) {
      alert('í”½ì—… ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      hourSelect.focus();
      return;
    }

    // ìœ íš¨ì„± ê²€ì¦ 2: ì¥ì†Œ ì„ íƒ
    if (!pickupSelect.value) {
      alert('í”½ì—… ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      pickupSelect.focus();
      return;
    }

    // ìœ íš¨ì„± ê²€ì¦ 3: ì”ì•¡ í™•ì¸
    const totalPrice = UNIT_PRICE * currentQty;
    const remaining = USER_BALANCE - totalPrice;

    if (remaining < 0) {
      alert('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¶©ì „ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì˜ˆì•½ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™ (íŒŒë¼ë¯¸í„° ì „ë‹¬)
    const hour = hourSelect.value;
    const minute = minuteSelect.value;
    const pickupPlace = pickupSelect.value;
    const quantity = currentQty;

    const completeUrl = `{% url 'lunch_complete' %}?hour=${hour}&minute=${minute}&pickup_place=${pickupPlace}&quantity=${quantity}&total_price=${totalPrice}`;
    
    window.location.href = completeUrl;
  });
</script>

</body>
</html>