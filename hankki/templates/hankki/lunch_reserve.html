{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë„ì‹œë½ ì˜ˆì•½ - ë§ˆì„í•œë¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>

<div class="phone-frame">

  <!-- ìƒë‹¨ í—¤ë” -->
  <header class="mh-header">
    <button class="mh-back-btn" onclick="history.back()">&#x2039; Back</button>
    <div class="mh-header-title">ë„ì‹œë½ ì˜ˆì•½</div>
    <div class="mh-header-spacer"></div>
  </header>

  <form method="post" class="mh-form" id="reserve-form">
    {% csrf_token %}

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="mh-main">

      <!-- í”½ì—… ì‹œê°„ -->
      <section class="mh-card">
        <p class="mh-card-title-highlight">
          <strong>í”½ì—… ì‹œê°„</strong>ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>
        <p class="mh-help-text">í”½ì—… ê°€ëŠ¥ ì‹œê°„: 08:00 ~ 19:00</p>
        {{ form.pickup_date_time }}
      </section>

      <!-- í”½ì—… ì¥ì†Œ -->
      <section class="mh-card">
        <p class="mh-card-title-highlight">
          <strong>í”½ì—… ì¥ì†Œ</strong>ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>

        <select name="delivery_address" class="mh-input" id="pickup-select" required>
          <option value="">í”½ì—… ì¥ì†Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</option>
          <option value="hall">í•™ìƒíšŒê´€ í”½ì—…ì¡´</option>
          <option value="plaza">ì—°ì„¸í”Œë¼ì í”½ì—…ì¡´</option>
        </select>
      </section>

      <!-- ë„ì‹œë½ ì •ë³´ -->
      <section class="mh-card">
        <p class="mh-card-title">ì£¼ë¬¸í•  ë„ì‹œë½</p>

        {% for item in queryset %}
          <div class="mh-lunchbox-item">

            {% if item.lunchbox.image %}
              <div class="mh-lunchbox-img-wrap">
                <img src="{{ item.lunchbox.image.url }}"
                     alt="{{ item.lunchbox.name }}"
                     class="mh-lunchbox-img">
              </div>
            {% endif %}

            <div class="mh-lunchbox-details">
              <p class="mh-lunchbox-name">{{ item.lunchbox.name }}</p>

              <div class="mh-lunchbox-summary">
                <span class="mh-lunchbox-qty">{{ item.quantity }}ê°œ</span>
                <span class="mh-lunchbox-qty" style="padding-inline: 4px;"></span>
                <span class="mh-lunchbox-price">{{ item.lunchbox.price }}ì›</span>

                <a href="{% url 'hankki:del_cart' id=item.id %}?next={{ request.path }}"
               class="mh-remove-btn"
               title="ì£¼ë¬¸ í•­ëª© ì œê±°">
               ì œê±°
            </a>
              </div>
            </div>

          </div>
          {% empty %}
          <p class="mh-help-text">ì£¼ë¬¸í•  ë„ì‹œë½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endfor %}
      </section>

      <!-- ê²°ì œ ì •ë³´ -->
      <section class="mh-card">
        <p class="mh-card-title">ê²°ì œì˜ˆì •ê¸ˆì•¡</p>

        <div class="mh-payment-detail">
          <div class="mh-payment-row">
            <span class="mh-payment-label">ì”ì•¡</span>
            <span class="mh-payment-value" id="balance-display">50,000ì›</span>
          </div>
          <div class="mh-payment-row">
            <span class="mh-payment-label">ê²°ì œê¸ˆì•¡</span>
            <span class="mh-payment-value" id="payment-amount">9,000ì›</span>
          </div>
          <div class="mh-payment-divider"></div>
          <div class="mh-payment-row mh-payment-result">
            <span class="mh-payment-label" id="result-label">ë‚¨ì€ ì”ì•¡</span>
            <span class="mh-payment-value" id="result-amount">41,000ì›</span>
          </div>
        </div>

        <!-- ì”ì•¡ ë¶€ì¡± ê²½ê³  -->
        <div class="mh-balance-warning" id="balance-warning">
          <p>ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!</p>
          <p>
            <a href="{% url 'hankki:charge' %}" class="mh-charge-link" id="charge-link">ì¶©ì „í•˜ê¸°</a>
          </p>
        </div>
      </section>

      <!-- hidden inputs for form submission -->
      <input type="hidden" name="quantity" id="hidden-quantity" value="1">
      <input type="hidden" name="total_price" id="hidden-total-price" value="9000">

    </main>

    <!-- í•˜ë‹¨ ì˜ˆì•½ ë²„íŠ¼ -->
    <div class="mh-bottom-btn-wrap">
      <button type="submit" class="mh-main-btn" id="reserve-btn">ì˜ˆì•½í•˜ê¸°</button>
    </div>

  </form>

</div>

<script>
  const UNIT_PRICE = {{ price_sum }};

  const STOCK_QTY = 1;

  // ğŸ”´ ë°±ì—”ë“œ ì—°ë™ ì‹œ: const USER_BALANCE = {{ user.balance }};
  // URL íŒŒë¼ë¯¸í„°ë¡œ balance ë°›ê¸° (chargeì—ì„œ ì „ë‹¬)
  const urlParams = new URLSearchParams(window.location.search);
  const USER_BALANCE = parseInt(urlParams.get('balance')) || 50000;

  const MIN_QTY = 1;
  const MAX_QTY = 10;

  let currentQty = 1;

  // DOM ìš”ì†Œ
  const qtyDisplay = document.getElementById('qty-display');
  const stockInfo = document.getElementById('stock-info');
  const stockWarning = document.getElementById('stock-warning');
  // const totalPriceSpan = document.getElementById('total-price').querySelector('span');
  const balanceDisplay = document.getElementById('balance-display');
  const paymentAmount = document.getElementById('payment-amount');
  const resultLabel = document.getElementById('result-label');
  const resultAmount = document.getElementById('result-amount');
  const balanceWarning = document.getElementById('balance-warning');
  const chargeLink = document.getElementById('charge-link');
  const reserveBtn = document.getElementById('reserve-btn');

  const hiddenQuantity = document.getElementById('hidden-quantity');
  const hiddenTotalPrice = document.getElementById('hidden-total-price');

  // ì´ˆê¸° í‘œì‹œ
  balanceDisplay.textContent = formatNumber(USER_BALANCE) + 'ì›';
  updateDisplay();

  // ìˆ˜ëŸ‰ ì¦ê°€
  document.getElementById('qty-plus').addEventListener('click', function() {
    if (currentQty < Math.min(STOCK_QTY, MAX_QTY)) {
      currentQty++;
      updateDisplay();
    }

    if (currentQty === Math.min(STOCK_QTY, MAX_QTY)) {
      stockWarning.style.display = 'block';
    }
  });

  // ìˆ˜ëŸ‰ ê°ì†Œ
  document.getElementById('qty-minus').addEventListener('click', function() {
    if (currentQty > MIN_QTY) {
      currentQty--;
      updateDisplay();
      stockWarning.style.display = 'none';
    }
  });

  // í™”ë©´ ì—…ë°ì´íŠ¸
  function updateDisplay() {
    const totalPrice = {{ price_sum }};
    const remaining = USER_BALANCE - totalPrice;

    // ìˆ˜ëŸ‰ ë° ê°€ê²© í‘œì‹œ
    // qtyDisplay.textContent = currentQty + 'ê°œ';
    // totalPriceSpan.textContent = formatNumber(totalPrice) + 'ì›';
    paymentAmount.textContent = formatNumber(totalPrice) + 'ì›';

    // hidden inputs ì—…ë°ì´íŠ¸
    hiddenQuantity.value = currentQty;
    hiddenTotalPrice.value = totalPrice;

    // ì”ì•¡ ì²´í¬
    if (remaining < 0) {
      // ì”ì•¡ ë¶€ì¡±
      resultLabel.textContent = 'ë¶€ì¡± ê¸ˆì•¡';
      resultAmount.textContent = formatNumber(Math.abs(remaining)) + 'ì›';
      resultAmount.style.color = '#e03131';
      balanceWarning.style.display = 'block';

      // ì¶©ì „í•˜ê¸° ë§í¬ í”ë“¤ë¦¼
      chargeLink.classList.add('shake');
      setTimeout(() => {
        chargeLink.classList.remove('shake');
      }, 1500);
    } else {
      // ì”ì•¡ ì¶©ë¶„
      resultLabel.textContent = 'ë‚¨ì€ ì”ì•¡';
      resultAmount.textContent = formatNumber(remaining) + 'ì›';
      resultAmount.style.color = '#12b886';
      balanceWarning.style.display = 'none';
    }
  }

  // ìˆ«ì í¬ë§·
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
</script>

</body>
</html>